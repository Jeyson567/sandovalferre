<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>POS – Paso 3</title>

<style>
table { width:100%; border-collapse:collapse; }
th, td { border-bottom:1px solid #ccc; padding:4px; }
.total { font-size:18px; font-weight:bold; text-align:right; }
</style>
</head>

<body>

<h2>POS – FERRETERÍA (Paso 3 – Inventario + Cantidad)</h2>

<h3>Registrar producto</h3>
<input id="codigo" placeholder="Código de barras">
<input id="nombre" placeholder="Nombre del producto">
<input id="precio" type="number" placeholder="Precio normal (Q)">
<input id="precioMin" type="number" placeholder="Precio mínimo permitido (Q)">
<input id="stock" type="number" placeholder="Existencia">
<button onclick="guardar()">Guardar producto</button>

<hr>

<h3>Venta</h3>
<input id="scan" placeholder="Escanear / escribir código y ENTER">

<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cant</th>
  <th>Precio</th>
  <th>Total</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total" id="totalVenta">Total: Q0.00</div>

<button onclick="finalizar()">Finalizar venta</button>

<script>
let inventario = JSON.parse(localStorage.getItem("inv")) || {};
let carrito = [];

function guardar() {
  const c = codigo.value.trim();
  const n = nombre.value.trim();
  const p = Number(precio.value);
  const pmin = Number(precioMin.value);
  const s = Number(stock.value);

  if (!c || !n || !p || !pmin || !s) {
    alert("Complete todos los campos");
    return;
  }

  if (pmin > p) {
    alert("Precio mínimo mayor al normal");
    return;
  }

  inventario[c] = {
    nombre: n,
    precio: p,
    precioMin: pmin,
    stock: s
  };

  localStorage.setItem("inv", JSON.stringify(inventario));
  alert("Producto guardado");

  codigo.value = nombre.value = precio.value = precioMin.value = stock.value = "";
}

scan.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    agregar(scan.value.trim());
    scan.value = "";
  }
});

function agregar(c) {
  const p = inventario[c];
  if (!p) {
    alert("Producto no registrado");
    return;
  }

  if (p.stock <= 0) {
    alert("❌ Sin existencia");
    return;
  }

  let cant = Number(prompt(
    "Producto: " + p.nombre +
    "\nExistencia disponible: " + p.stock +
    "\n\n¿Cuántas unidades llevará?"
  ));

  if (!cant || cant <= 0) {
    alert("Cantidad inválida");
    return;
  }

  if (cant > p.stock) {
    alert("No hay suficiente existencia");
    return;
  }

  let precioVenta = Number(prompt(
    "Precio normal: Q" + p.precio +
    "\nPrecio mínimo permitido: Q" + p.precioMin +
    "\n\nPrecio a cobrar por unidad:",
    p.precio
  ));

  if (precioVenta < p.precioMin) {
    alert("No se permite vender debajo del precio mínimo");
    return;
  }

  p.stock -= cant;

  carrito.push({
    nombre: p.nombre,
    cant: cant,
    precio: precioVenta,
    total: cant * precioVenta
  });

  localStorage.setItem("inv", JSON.stringify(inventario));
  actualizar();
}

function actualizar() {
  tabla.innerHTML = "";
  let total = 0;

  carrito.forEach(i => {
    total += i.total;
    tabla.innerHTML += `
      <tr>
        <td>${i.nombre}</td>
        <td>${i.cant}</td>
        <td>Q${i.precio.toFixed(2)}</td>
        <td>Q${i.total.toFixed(2)}</td>
      </tr>
    `;
  });

  totalVenta.textContent = "Total: Q" + total.toFixed(2);
}

function finalizar() {
  if (carrito.length === 0) {
    alert("No hay productos");
    return;
  }

  alert(
    "Venta finalizada\n" +
    "Productos distintos: " + carrito.length + "\n" +
    totalVenta.textContent
  );

  carrito = [];
  actualizar();
}
</script>

</body>
</html>