<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>POS ‚Äì Ferreter√≠a Sandoval</title>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; padding:10px; }
h2 { text-align:center; }
section { background:#fff; padding:10px; margin-bottom:10px; border-radius:6px; }
input, button { width:100%; padding:6px; margin:4px 0; }
button { cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:6px; }
th, td { border-bottom:1px solid #ccc; padding:4px; }
.total { font-size:18px; font-weight:bold; text-align:right; }
.danger { background:#c62828; color:#fff; }
.secondary { background:#757575; color:#fff; }
</style>
</head>

<body>

<h2>POS ‚Äì FERRETER√çA SANDOVAL</h2>

<section>
<h3>üì¶ Registrar / Agregar Existencia</h3>
<input id="codigo" placeholder="C√≥digo de barras">
<input id="nombre" placeholder="Nombre del producto">
<input id="precio" type="number" placeholder="Precio normal (Q)">
<input id="precioMin" type="number" placeholder="Precio m√≠nimo permitido (Q)">
<input id="stock" type="number" placeholder="Cantidad a agregar">
<button onclick="guardar()">Guardar / Sumar</button>
<button class="danger" onclick="eliminarProducto()">Eliminar producto</button>
</section>

<section>
<h3>üìã Inventario</h3>
<table>
<thead>
<tr>
  <th>C√≥digo</th>
  <th>Producto</th>
  <th>Stock</th>
  <th>Precio</th>
  <th>M√≠nimo</th>
</tr>
</thead>
<tbody id="tablaInv"></tbody>
</table>
</section>

<section>
<h3>üõí Venta</h3>
<input id="scan" placeholder="C√≥digo + ENTER">
<table>
<thead>
<tr>
  <th>Producto</th>
  <th>Cant</th>
  <th>Precio</th>
  <th>Total</th>
</tr>
</thead>
<tbody id="tablaVenta"></tbody>
</table>

<div class="total" id="totalVenta">Total: Q0.00</div>

<button onclick="finalizarVenta()">Finalizar venta</button>
<button class="secondary" onclick="cancelarVenta()">Cancelar venta</button>
</section>

<script>
let inventario = JSON.parse(localStorage.getItem("inv")) || {};
let carrito = [];

/* ===== INVENTARIO ===== */
function guardar() {
  const c = codigo.value.trim();
  const n = nombre.value.trim();
  const p = Number(precio.value);
  const pmin = Number(precioMin.value);
  const s = Number(stock.value);

  if (!c || !s) {
    alert("C√≥digo y cantidad son obligatorios");
    return;
  }

  if (inventario[c]) {
    inventario[c].stock += s;
    alert("‚úÖ Existencia agregada");
  } else {
    if (!n || !p || !pmin) {
      alert("Complete todos los datos del producto");
      return;
    }
    if (pmin > p) {
      alert("Precio m√≠nimo mayor al normal");
      return;
    }
    inventario[c] = {
      nombre:n,
      precio:p,
      precioMin:pmin,
      stock:s
    };
    alert("‚úÖ Producto creado");
  }

  localStorage.setItem("inv", JSON.stringify(inventario));
  limpiarCampos();
  mostrarInventario();
}

function eliminarProducto() {
  const c = codigo.value.trim();
  if (!c) return alert("Ingrese el c√≥digo");

  if (!inventario[c]) return alert("El producto no existe");

  if (!confirm(
    "¬øEliminar este producto?\n\n" +
    inventario[c].nombre +
    "\nStock: " + inventario[c].stock
  )) return;

  delete inventario[c];
  localStorage.setItem("inv", JSON.stringify(inventario));
  limpiarCampos();
  mostrarInventario();
  alert("üóëÔ∏è Producto eliminado");
}

function limpiarCampos() {
  codigo.value = nombre.value = precio.value = precioMin.value = stock.value = "";
}

function mostrarInventario() {
  tablaInv.innerHTML = "";
  for (let c in inventario) {
    const p = inventario[c];
    tablaInv.innerHTML += `
      <tr>
        <td>${c}</td>
        <td>${p.nombre}</td>
        <td>${p.stock}</td>
        <td>Q${p.precio.toFixed(2)}</td>
        <td>Q${p.precioMin.toFixed(2)}</td>
      </tr>
    `;
  }
}

/* ===== VENTA ===== */
scan.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    agregarAlCarrito(scan.value.trim());
    scan.value = "";
  }
});

function agregarAlCarrito(c) {
  const p = inventario[c];
  if (!p) return alert("Producto no registrado");
  if (p.stock <= 0) return alert("Sin existencia");

  let cant = Number(prompt(
    `Producto: ${p.nombre}\nExistencia disponible: ${p.stock}\n\n¬øCu√°ntas unidades llevar√°?`
  ));

  if (!cant || cant <= 0 || cant > p.stock) return alert("Cantidad inv√°lida");

  let precioVenta = Number(prompt(
    `Precio normal: Q${p.precio}\nPrecio m√≠nimo: Q${p.precioMin}\n\nPrecio por unidad:`,
    p.precio
  ));

  if (precioVenta < p.precioMin) return alert("Precio debajo del m√≠nimo");

  carrito.push({
    codigo: c,
    nombre: p.nombre,
    cant: cant,
    precio: precioVenta,
    total: cant * precioVenta
  });

  actualizarVenta();
}

function actualizarVenta() {
  tablaVenta.innerHTML = "";
  let total = 0;

  carrito.forEach(i => {
    total += i.total;
    tablaVenta.innerHTML += `
      <tr>
        <td>${i.nombre}</td>
        <td>${i.cant}</td>
        <td>Q${i.precio.toFixed(2)}</td>
        <td>Q${i.total.toFixed(2)}</td>
      </tr>
    `;
  });

  totalVenta.textContent = "Total: Q" + total.toFixed(2);
}

function finalizarVenta() {
  if (carrito.length === 0) return alert("No hay productos");

  // Validar stock antes de confirmar
  for (let item of carrito) {
    if (inventario[item.codigo].stock < item.cant) {
      alert("‚ùå Stock insuficiente para: " + item.nombre);
      return;
    }
  }

  // Descontar stock ahora s√≠
  carrito.forEach(item => {
    inventario[item.codigo].stock -= item.cant;
  });

  localStorage.setItem("inv", JSON.stringify(inventario));

  carrito = [];
  actualizarVenta();
  mostrarInventario();

  alert("‚úÖ Venta finalizada correctamente");
}

function cancelarVenta() {
  if (carrito.length === 0) return;
  if (!confirm("¬øCancelar la venta actual?")) return;

  carrito = [];
  actualizarVenta();
  alert("Venta cancelada. Inventario intacto.");
}

mostrarInventario();
</script>

</body>
</html>