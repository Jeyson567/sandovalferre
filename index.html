<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>POS ‚Äì Ferreter√≠a y ventas de materiales machaquila</title>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; padding:10px; }
h2 { text-align:center; }
section { background:#fff; padding:10px; margin-bottom:10px; border-radius:6px; }
input, button { width:100%; padding:6px; margin:4px 0; }
button { cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:6px; }
th, td { border-bottom:1px solid #ccc; padding:4px; }
.total { font-size:18px; font-weight:bold; text-align:right; }
.danger { background:#c62828; color:#fff; }
.secondary { background:#757575; color:#fff; }

@media print {
  body { width:80mm; margin:0; background:#fff; font-size:12px; }
  .no-print { display:none; }
}
</style>
</head>

<body>

<h2 class="no-print">POS ‚Äì ferreteria y ventas de materiales machaquila</h2>

<!-- INVENTARIO -->
<section class="no-print">
<h3>üì¶ Registrar / Agregar Existencia</h3>
<input id="codigo" placeholder="C√≥digo de barras">
<input id="nombre" placeholder="Nombre del producto">
<input id="precio" type="number" placeholder="Precio normal (Q)">
<input id="precioMin" type="number" placeholder="Precio m√≠nimo permitido (Q)">
<input id="stock" type="number" placeholder="Cantidad a agregar">
<button onclick="guardar()">Guardar / Sumar</button>
<button class="danger" onclick="eliminarProducto()">Eliminar producto</button>
</section>

<section class="no-print">
<h3>üìã Inventario</h3>
<table>
<thead>
<tr><th>C√≥digo</th><th>Producto</th><th>Stock</th></tr>
</thead>
<tbody id="tablaInv"></tbody>
</table>

<h4>üîç Buscar producto por nombre</h4>
<input id="buscar" placeholder="Escribe el nombre del producto">
<table>
<thead>
<tr><th>Producto</th><th>Stock</th><th>Acci√≥n</th></tr>
</thead>
<tbody id="tablaBusqueda"></tbody>
</table>
</section>

<!-- VENTA -->
<section class="no-print">
<h3>üõí Venta</h3>
<input id="scan" placeholder="C√≥digo + ENTER">
<table>
<thead>
<tr><th>Producto</th><th>Cant</th><th>Total</th></tr>
</thead>
<tbody id="tablaVenta"></tbody>
</table>
<div class="total" id="totalVenta">Total: Q0.00</div>
<button onclick="finalizarVenta()">Finalizar venta e imprimir</button>
<button class="secondary" onclick="cancelarVenta()">Cancelar venta</button>
</section>

<section class="no-print">
<button onclick="cerrarDia()">üìä Cerrar d√≠a y enviar WhatsApp</button>
</section>

<script>
const telefonoJefe = "50249805357";

let inventario = JSON.parse(localStorage.getItem("inv")) || {};
let carrito = [];
let ventasDia = JSON.parse(localStorage.getItem("ventasDia")) || [];

/* ===== INVENTARIO ===== */
function guardar() {
  const c = codigo.value.trim();
  const n = nombre.value.trim();
  const p = Number(precio.value);
  const pmin = Number(precioMin.value);
  const s = Number(stock.value);

  if (!c || !s) return alert("C√≥digo y cantidad obligatorios");

  if (inventario[c]) {
    inventario[c].stock += s;
  } else {
    if (!n || !p || !pmin) return alert("Complete todos los datos");
    inventario[c] = { nombre:n, precio:p, precioMin:pmin, stock:s };
  }

  localStorage.setItem("inv", JSON.stringify(inventario));
  limpiar();
  mostrarInventario();
}

function eliminarProducto() {
  const c = codigo.value.trim();
  if (!inventario[c]) return alert("No existe");
  if (!confirm("¬øEliminar producto?")) return;
  delete inventario[c];
  localStorage.setItem("inv", JSON.stringify(inventario));
  limpiar();
  mostrarInventario();
}

function limpiar() {
  codigo.value = nombre.value = precio.value = precioMin.value = stock.value = "";
}

function mostrarInventario() {
  tablaInv.innerHTML = "";
  for (let c in inventario) {
    tablaInv.innerHTML += `<tr>
      <td>${c}</td>
      <td>${inventario[c].nombre}</td>
      <td>${inventario[c].stock}</td>
    </tr>`;
  }
}

/* ===== BUSCADOR ===== */
buscar.addEventListener("input", function () {
  const texto = this.value.toLowerCase();
  tablaBusqueda.innerHTML = "";
  if (texto.length < 2) return;

  for (let c in inventario) {
    const p = inventario[c];
    if (p.nombre.toLowerCase().includes(texto)) {
      tablaBusqueda.innerHTML += `
        <tr>
          <td>${p.nombre}</td>
          <td>${p.stock}</td>
          <td><button onclick="agregar('${c}')">Agregar</button></td>
        </tr>
      `;
    }
  }
});

/* ===== VENTA ===== */
scan.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    agregar(scan.value.trim());
    scan.value = "";
  }
});

function agregar(c) {
  const p = inventario[c];
  if (!p || p.stock <= 0) return alert("No disponible");

  let cant = Number(prompt(`Existencia: ${p.stock}\nCantidad:`));
  if (!cant || cant > p.stock) return;

  let precioVenta = Number(prompt(
    `Precio normal: Q${p.precio}\nPrecio m√≠nimo: Q${p.precioMin}\nPrecio por unidad:`,
    p.precio
  ));
  if (precioVenta < p.precioMin) return alert("Debajo del m√≠nimo");

  carrito.push({ codigo:c, nombre:p.nombre, cant, precio:precioVenta, total:cant*precioVenta });
  actualizarVenta();
}

function actualizarVenta() {
  tablaVenta.innerHTML = "";
  let total = 0;
  carrito.forEach(i => {
    total += i.total;
    tablaVenta.innerHTML += `<tr>
      <td>${i.nombre} x${i.cant}</td>
      <td>Q${i.total.toFixed(2)}</td>
    </tr>`;
  });
  totalVenta.textContent = "Total: Q" + total.toFixed(2);
}

function finalizarVenta() {
  if (carrito.length === 0) return;

  carrito.forEach(i => {
    inventario[i.codigo].stock -= i.cant;
  });

  ventasDia.push(...carrito);
  localStorage.setItem("ventasDia", JSON.stringify(ventasDia));
  localStorage.setItem("inv", JSON.stringify(inventario));

  imprimirTicket();
  carrito = [];
  actualizarVenta();
  mostrarInventario();
}

function cancelarVenta() {
  carrito = [];
  actualizarVenta();
}

/* ===== TICKET ===== */
function imprimirTicket() {
  let html = `
  <center><strong>Ferreter√≠a y ventas de materiales machaquila</strong></center>
  <center>${new Date().toLocaleString()}</center>
  <hr>`;
  carrito.forEach(i=>{
    html+=`${i.nombre}<br>${i.cant} x Q${i.precio} = Q${i.total}<br>`;
  });
  const total = carrito.reduce((s,i)=>s+i.total,0);
  html+=`<hr><strong>TOTAL: Q${total.toFixed(2)}</strong><br><br>Gracias por su compra`;
  document.body.innerHTML = html;
  window.print();
  location.reload();
}

/* ===== CIERRE ===== */
function cerrarDia() {
  if (ventasDia.length === 0) return alert("No hay ventas");

  let resumen = {};
  let total = 0;

  ventasDia.forEach(v=>{
    if (!resumen[v.nombre]) resumen[v.nombre]={cant:0,total:0};
    resumen[v.nombre].cant += v.cant;
    resumen[v.nombre].total += v.total;
    total += v.total;
  });

  let mensaje = `üìä CIERRE DIARIO ‚Äì FERRETER√çA SANDOVAL\n`;
  mensaje += `Fecha: ${new Date().toLocaleDateString()}\n\nüì¶ DETALLE:\n\n`;

  for (let p in resumen) {
    mensaje += `- ${p}\n  Cantidad: ${resumen[p].cant}\n  Total: Q${resumen[p].total.toFixed(2)}\n\n`;
  }

  mensaje += `üí∞ TOTAL DEL D√çA: Q${total.toFixed(2)}`;

  window.open(`https://wa.me/${telefonoJefe}?text=${encodeURIComponent(mensaje)}`);

  ventasDia = [];
  localStorage.removeItem("ventasDia");
  alert("‚úÖ Cierre enviado. Ventas reiniciadas.");
}

mostrarInventario();
</script>

</body>
</html